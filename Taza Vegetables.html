<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taza Vegetables</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(to right, #12c399, #8c00ff);
            color: white;
            text-align: center;
            margin: 0;
            padding: 0;
           }
           h4 {
            color: rgb(124, 243, 5);
            font-size: 40px;
            font-weight: bold;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
        }

        button:hover {
            background: #d8922a;
        }
        .auth-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }
        nav ul {
            list-style: none;
            padding-top: 90px; 
            margin:10px ;            
        }
        nav ul li {
            display: inline;
            margin: 10px;
        }
        nav ul li a {
            color: white;
            text-decoration: none;
            font-size:20px;
            border: 3px solid #14b153;
            border-radius:10px;
        }
        #image-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top:15px;
            justify-content: center;
        }
        #image-preview img {
            width: 100px;
            height: 100px;
            border-radius: 10px;
            object-fit: cover;
            border: 2px solid #0bddec;
            padding: 5px;
        }
        .search-bar {
            margin-top:0px;
        }
        input[type="text"] {
            padding: 10px;
            width: 60%;
            border: none;
            border-radius: 5px;
        }
        button {
            padding: 10px 15px;
            border: none;
            background: #ff9800;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #d8922a;
        }
        .chat-container {
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }
        .chat-box {
            height: 200px;
            overflow-y: scroll;
            border: 1px solid white;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
        }
        .chat-input {
            width: 80%;
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
            border: none;
        }
        .seller-info {
            margin-top: 20px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            text-align: center;
        }
    </style>
</head>
<body> 
    <h4>Taza Vegetables</h4>
    
    
    <main>
        <section>
            <nav>
                <ul>
                    <li><a href="#" id="home-link">Home</a></li>
                    <li><a href="#" id="register-link">Register</a></li>
                    <li><a href="#" id="login-link">Login</a></li>
                </ul>
            </nav>
            <div class="auth-container" id="register-container" style="display: none;">
                <h2>Register</h2>
                <form id="register-form">
                    <input type="text" id="name" placeholder="Name" required><br>
                    <input type="email" id="email" placeholder="Email" required><br>
                    <input type="password" id="password" placeholder="Password" required><br>
                    <button type="submit">Register</button>
                </form>
            </div>
            <div class="auth-container" id="login-container" style="display: none;">
                <h2>Login</h2>
                <form id="login-form">
                    <input type="email" id="email-login" placeholder="Email" required><br>
                    <input type="password" id="password-login" placeholder="Password" required><br>
                    <button type="submit">Login</button>
                </form>
            </div>
        </section>
        <section class="search-bar">
            <input type="text" id="search" placeholder="Search for vegetables, sellers...">
            <button onclick="searchItems()">Search</button>
        </section>
        <section>
        </div>
        <div class="auth-container" id="login-container" style="display: none;">
            <h2>Login</h2>
            <form id="login-form">
                <input type="email" id="email-login" placeholder="Email" required><br>
                <input type="password" id="password-login" placeholder="Password" required><br>
                <button type="submit">Login</button>
            </form>
        </div>
        </section>
        <section id="seller-profile" class="profile-section">
            <h2>Seller Profile</h2>
            <p>Upload up to  images of your vegetables and update your contact details.</p>
            <input type="file" multiple accept="image/*" onchange="previewImages(event)">

            <div id="image-preview"></div>
        </section>
        <section> 
         <div class="chat-container">
            <h3>Seller & Buyer Chat</h3>
            <div class="chat-box" id="chat-box"></div>
            <input type="text" id="chat-message" class="chat-input" placeholder="Type a message...">
            <button onclick="sendMessage()">Send</button>
         </div>
         
         <div class="seller-info">
            <h3>Seller Contact Information</h3>
            <p><strong>Contact Number:</strong> <span id="seller-contact">+91 9546386072</span></p>
            <p><strong>Real-Time Location:</strong> <span id="seller-location">Fetching location...</span></p>
         </div>
        </section> 
    </main>
    
    <script>
        function searchItems() {
            let query = document.getElementById("search").value;
            if (query.trim() !== "") {
                alert("Searching for: " + query);
            } else {
                alert("Please enter a search term.");
            }
        }
        
           
        document.getElementById('register-link').addEventListener('click', () => {
            document.getElementById('register-container').style.display = 'block';
            document.getElementById('login-container').style.display = 'none';
        });
        document.getElementById('login-link').addEventListener('click', () => {
            document.getElementById('login-container').style.display = 'block';
            document.getElementById('register-container').style.display = 'none';
        });
       
        function showProfile(type) {
            document.getElementById("seller-profile").style.display = "none";
            document.getElementById("buyer-profile").style.display = "none";
            document.getElementById(type + "-profile").style.display = "block";
        }

        function previewImages(event) {
            let imagePreview = document.getElementById("image-preview");
            let files = event.target.files; // Get selected files

            for (let i = 0; i < files.length; i++) { // Loop through files
                let file = files[i];
                let reader = new FileReader();

                reader.onload = function(e) { // When file is read
                    let container = document.createElement("div");
                    container.classList.add("image-container");

                    let img = document.createElement("img");
                    img.src = e.target.result;

                    let removeBtn = document.createElement("button");
                    removeBtn.innerText = "X";
                    removeBtn.classList.add("remove-btn");
                    removeBtn.onclick = function() {
                        container.remove(); // Remove the selected image
                    };

                    container.appendChild(img);
                    container.appendChild(removeBtn);
                    imagePreview.appendChild(container); // Add image with remove button
                };

                reader.readAsDataURL(file); // Read file as Data URL
            }
        }
        function sendMessage() {
            let chatBox = document.getElementById("chat-box");
            let message = document.getElementById("chat-message").value;
            if (message.trim() !== "") {
                let msgDiv = document.createElement("div");
                msgDiv.textContent = message;
                msgDiv.style.padding = "5px";
                msgDiv.style.margin = "5px 0";
                msgDiv.style.background = "#ff9800";
                msgDiv.style.borderRadius = "5px";
                chatBox.appendChild(msgDiv);
                chatBox.scrollTop = chatBox.scrollHeight;
                document.getElementById("chat-message").value = "";
            }
        }

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    let lat = position.coords.latitude;
                    let lon = position.coords.longitude;
                    document.getElementById("seller-location").textContent = `Lat: ${lat}, Lon: ${lon}`;
                });
            } else {
                document.getElementById("seller-location").textContent = "Location access denied.";
            }
        }
        
       getLocation();

    require("dotenv").config();
    const express = require("express");
    const mongoose = require("mongoose");
    const cors = require("cors");
    const bcrypt = require("bcryptjs");
    const jwt = require("jsonwebtoken");
            const multer = require("multer");
            const http = require("http");
            const { Server } = require("socket.io");

    const app = express();
    app.use(cors());
    app.use(express.json());

    mongoose.connect(process.env.MONGO_URI, {
    useNewUrlParser: true,
    useUnifiedTopology: true,
        }).then(() => console.log("Database connected"))
        .catch(err => console.log(err));

    const server = http.createServer(app);
    const io = new Server(server, {
    cors: { origin: "*" }
});

// **User Schema**
const UserSchema = new mongoose.Schema({
    name: String,
    email: { type: String, unique: true },
    password: String,
    role: { type: String, enum: ["buyer", "seller"] },
    location: String,
    contact: String,
});
const User = mongoose.model("User", UserSchema);

// **Seller Schema**
const SellerSchema = new mongoose.Schema({
    userId: mongoose.Schema.Types.ObjectId,
    images: [String],
    description: String,
});
const Seller = mongoose.model("Seller", SellerSchema);

// **Register User**
app.post("/api/auth/register", async (req, res) => {
    try {
        const { name, email, password, role, location, contact } = req.body;
        const salt = await bcrypt.genSalt(10);
        const hashedPassword = await bcrypt.hash(password, salt);
        const newUser = new User({ name, email, password: hashedPassword, role, location, contact });
        await newUser.save();
        res.status(201).json({ message: "User registered successfully" });
    } catch (err) {
        res.status(500).json({ error: err.message });
    }
});

// **Login User**
app.post("/api/auth/login", async (req, res) => {
    try {
        const { email, password } = req.body;
        const user = await User.findOne({ email });
        if (!user) return res.status(400).json({ message: "User not found" });
        const validPassword = await bcrypt.compare(password, user.password);
        if (!validPassword) return res.status(400).json({ message: "Invalid password" });
        const token = jwt.sign({ userId: user._id }, process.env.JWT_SECRET, { expiresIn: "1d" });
        res.json({ token, user });
    } catch (err) {
        res.status(500).json({ error: err.message });
    }
});

// **Multer for Image Upload**
const storage = multer.diskStorage({
    destination: (req, file, cb) => cb(null, "uploads/"),
    filename: (req, file, cb) => cb(null, Date.now() + "-" + file.originalname),
});
const upload = multer({ storage });

// **Upload Seller Image**
app.post("/api/seller/upload", upload.array("images", 5), async (req, res) => {
    try {
        const { userId, description } = req.body;
        const imageUrls = req.files.map(file => `/uploads/${file.filename}`);
        const newSeller = new Seller({ userId, images: imageUrls, description });
        await newSeller.save();
        res.json({ message: "Images uploaded", images: imageUrls });
    } catch (err) {
        res.status(500).json({ error: err.message });
    }
});

// **Real-time Chat with Socket.io**
io.on("connection", (socket) => {
    console.log("New user connected", socket.id);
    socket.on("sendMessage", (data) => {
        io.emit("receiveMessage", data);
    });
    socket.on("disconnect", () => {
        console.log("User disconnected", socket.id);
    });
});

const PORT = process.env.PORT || 5000;
server.listen(PORT, () => {
    console.log(`Server running on port ${PORT}`);
});

         
    </script>
</body>
</html>
